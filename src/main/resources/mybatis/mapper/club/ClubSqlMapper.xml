<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.psychopath.dogstalking.club.mapper.ClubSqlMapper">

    <insert id="insertFreeBoard">
        INSERT INTO ms_club_freeboard(club_pk,user_pk,title,content)
        VALUES (#{club_pk},#{user_pk},#{title},#{content})
    </insert>


    <select id="selectFreeBoardAll" resultType="map">
        SELECT *
        FROM ms_club_freeboard
        JOIN ms_user ON ms_user.USER_PK = ms_club_freeboard.user_pk
        where ms_club_freeboard.club_pk=#{club_pk}
    </select>

    <!-- 댓글 -->

	<insert id="insertComment">
		INSERT INTO ms_club_freeboard_comment(user_pk,clubfreeboard_pk,content)
        VALUES (#{user_pk},#{clubfreeboard_pk},#{content})
        
	</insert>

    <select id="selectCommentAll" resultType="map">
    SELECT * FROM ms_club_freeboard_comment
    JOIN ms_user ON ms_user.USER_PK = ms_club_freeboard_comment.user_pk
    WHERE clubfreeboard_pk = #{clubfreeboard_pk}
    </select>

    <!-- 길드 가입 여부 -->
    <select id="applyClubUserTF" resultType="map">
    <![CDATA[
        SELECT 
    COALESCE(CASE WHEN COUNT(*) > 0 THEN 'T' ELSE 'F' END, 'F') AS user_exists,
    ms_club_user.*,
    ms_user.*,
    ms_club.*,
    ms_club_user_statuslog.*,
    ms_club.name AS clubname,
    ms_club.content AS clubcontent
    FROM 
        ms_user
    LEFT JOIN 
        ms_club_user ON ms_user.user_pk = ms_club_user.user_pk
    LEFT JOIN 
        ms_club ON ms_club.club_pk = ms_club_user.club_pk 
    left join 
        ms_club_user_statuslog on ms_club_user_statuslog.club_user_pk = ms_club_user.user_pk  
    WHERE 
        ms_club_user.user_pk = #{user_pk}
    ]]>
    </select>


    <!--길드 개설-->
    <insert id="insertClub">
		INSERT INTO ms_club(name,content)
        VALUES (#{name},#{content})
	</insert>

    <insert id="insertClubUser">
		INSERT INTO ms_club_user(user_pk,club_pk,content)
        VALUES (#{user_pk},#{club_pk},"길드 개설자")
	</insert>

    <insert id="insertClubUsers">
		INSERT INTO ms_club_user(user_pk,club_pk,content)
        VALUES (#{user_pk},#{club_pk},#{content})
	</insert>

    <select id="checka" resultType="int">
        SELECT COALESCE(MAX(club_user_pk), 0) FROM ms_club_user
    </select>

    <select id="checkb" resultType="int">
        SELECT MAX(club_pk) FROM ms_club;
    </select>
    
    <select id="selectClubPK" resultType="int">
        SELECT * FROM ms_club_user WHERE user_pk = #{user_pk};
    </select>
    
    <select id="selectClubList" resultType="map">
        SELECT * FROM ms_club ORDER BY RAND()
    </select>
     
    <select id="showclubpk" resultType="map">
        SELECT 
            1 AS clubpk_ck,
            ms_club.*
        FROM ms_club 
        WHERE ms_club.club_pk = #{club_pk}
    </select>
    

    <!--회원 신청 상태-->
    <insert id="insertUserStatusLog">
        INSERT INTO ms_club_user_statuslog(club_user_pk)
        VALUES (#{club_user_pk}); 
    </insert>

    <!--개설시 리더 자동 위임-->
    <insert id="insertLeader">
        INSERT INTO ms_club_user_ranklog(club_user_pk,clubuserranklogcategory_pk)
        VALUES (#{club_user_pk},1); 
    </insert>

    <!--가입신청목록-->
    <select id="selectApplyList" resultType="map">
        SELECT 
            ms_user.*,
            ms_club_user.*,
            ms_club_user_statuslog.*,
            ms_club_user_statuslog.created_at AS applydate
        FROM ms_club_user
        LEFT JOIN ms_club_user_statuslog ON ms_club_user_statuslog.club_user_pk = ms_club_user.user_pk
        left join ms_user on ms_user.user_pk =ms_club_user.user_pk 
        WHERE ms_club_user.club_pk = #{club_pk} AND ms_club_user_statuslog.clubcategory_pk = 2
    </select>
</mapper>