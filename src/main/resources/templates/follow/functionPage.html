<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <script src="https://kit.fontawesome.com/fdd6196f61.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a277eb582a644847f86de6196a42745f"></script>

        <script>

            let myUserPk;

            let map;

            let myLocation;

            let currentLat;
            let currentLng;

            const staticLat = 37.4996259;
            const staticLng = 127.0304801;

            let myTrackMarkers = [];
            let tracingTrackMarkers = [];
            let tracingTrackInfoMarkers = [];
            let scanningTrackMarkers = [];

            const alertTime = 1000;

            const trackMarkerEffectiveDistance = 100;
            const trackMarkerDateValidity = 7;
            const trackMarkerUpTo = 3;

            let scanMarkerEffectiveDistance = 250;
            let scanMarkerUpTo = 5;
            
            let collectMarkerUpTo = 3;

            function getMyUserPk() {

                const url = "./getMyUserPk";

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    myUserPk = response.data;
                    console.log(myUserPk);

                    getMyTrackMarkers();
                    getTracingTrackMarkers();

                });

            }

            function createMap() {

                const mapContainer = document.getElementById("map");
                mapOption = {
                    center: new kakao.maps.LatLng(staticLat, staticLng),
                    level: 4
                };

                map = new kakao.maps.Map(mapContainer, mapOption);

            }

            function getMyLocation() {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {

                        currentLat = position.coords.latitude;
                        currentLng = position.coords.longitude;

                        const currentPosition = new kakao.maps.LatLng(currentLat, currentLng)

                        displayMyLocation(currentPosition);
                    }, (error) => {

                        if(error.code === 3) {
                            document.getElementById("alertContent").innerText = "위치정보 확인이 지연되고 있습니다";
                            showAndHideAlertModal();
                        }else if(error.code === 1) {
                            document.getElementById("alertContent").innerText = "위치정보 허용이 필요합니다";
                            showAndHideAlertModal();
                        }else {
                            document.getElementById("alertContent").innerText = "예기치 못한 오류가 발생했습니다";
                            showAndHideAlertModal();
                        }

                        const staticPosition = new kakao.maps.LatLng(staticLat, staticLng);
                        displayMyLocation(staticPosition);

                        setTimeout(() => {
                            location.href = "/commons/mainPage";
                        }, alertTime);

                        });

                }else {
                    const staticPosition = new kakao.maps.LatLng(staticLat, staticLng);
                    displayMyLocation(staticPosition);

                    document.getElementById("alertContent").innerText = "위치정보 사용이 불가합니다";
                    showAndHideAlertModal();

                    setTimeout(() => {
                        location.href = "/commons/mainPage";
                    }, alertTime);
                }
            }

            function displayMyLocation(position) {

                if(myLocation) {
                    myLocation.setPosition(position);
                    map.panTo(position);

                    return;
                }

                // const content = document.createElement("div");
                // content.classList.add("myLocationMarkerBox");

                // const div1 = document.createElement("div");
                // div1.classList.add("myLocationMarker", "first");
                // const div2 = document.createElement("div");
                // div2.classList.add("myLocationMarker", "second");
                // const div3 = document.createElement("div");
                // div3.classList.add("myLocationMarker", "third");

                // content.appendChild(div1);
                // content.appendChild(div2);
                // content.appendChild(div3);
                
                // myLocation = new kakao.maps.CustomOverlay({
                //     position: position,
                //     content: content
                // });

                // myLocation.setMap(map);

                var marker = new kakao.maps.Marker({
                    position: position
                });

                // 마커가 지도 위에 표시되도록 설정합니다
                marker.setMap(map);

                map.panTo(position);

            }

            function displayMyTrackMarker(lat, lng) {

                const position = new kakao.maps.LatLng(lat, lng);

                var marker = new kakao.maps.Marker({
                    position: position
                });

                // 마커가 지도 위에 표시되도록 설정합니다
                marker.setMap(map);
                myTrackMarkers.push(marker);

            }

            function removeMyTrackMarkers() {
                for(var i = 0 ; i < myTrackMarkers.length ; i++) {
                    myTrackMarkers[i].setMap(null);
                }

                myTrackMarkers = [];
            }

            function displayTracingTrackAndInfoMarker(e) {

                const position = new kakao.maps.LatLng(e.latitude, e.longitude);

                var circle = new kakao.maps.Circle({
                    center : position,  // 원의 중심좌표 입니다 
                    radius: 50, // 미터 단위의 원의 반지름입니다 
                    strokeWeight: 5, // 선의 두께입니다 
                    strokeColor: '#75B8FA', // 선의 색깔입니다
                    strokeOpacity: 1, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
                    strokeStyle: 'dashed', // 선의 스타일 입니다
                    fillColor: '#CFE7FF', // 채우기 색깔입니다
                    fillOpacity: 0.7  // 채우기 불투명도 입니다   
                }); 

                // 지도에 원을 표시합니다 
                circle.setMap(map);

                var marker = new kakao.maps.Marker({
                    position: position
                });

                // 마커가 지도 위에 표시되도록 설정합니다
                marker.setMap(map);

                tracingTrackMarkers.push(circle);
                tracingTrackInfoMarkers.push(marker);

            }

            function removeTracingTrackAndInfoMarkers() {
                for(var i = 0 ; i < tracingTrackMarkers.length ; i++) {
                    tracingTrackMarkers[i].setMap(null);
                    tracingTrackInfoMarkers[i].setMap(null);
                }

                tracingTrackMarkers = [];
                tracingTrackInfoMarkers = [];
            }

            function displayScanningTrackMarkers(e) {

                const position = new kakao.maps.LatLng(e.latitude, e.longitude);

                var content = document.createElement("div");
                content.classList.add("bg-black", "text-white");
                content.innerText = e.user_pk;

                // 커스텀 오버레이를 생성합니다
                var customOverlay = new kakao.maps.CustomOverlay({
                    position: position,
                    content: content   
                });

                // 커스텀 오버레이를 지도에 표시합니다
                customOverlay.setMap(map);

                content.onclick = () => {
                    console.log("click");
                    fillPreviewTrackMarkerModal(e);

                };

                scanningTrackMarkers.push(customOverlay);

            }

            function removeScanningTrackMarkers() {
                for(var i = 0 ; i < scanningTrackMarkers.length ; i++) {
                    scanningTrackMarkers[i].setMap(null);
                }

                scanningTrackMarkers = [];
            }

            function getMyTrackMarkers() {

                removeMyTrackMarkers();

                const url = "./getMyTrackMarkers?user_pk=" + myUserPk + "&trackMarkerDateValidity=" + trackMarkerDateValidity;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    if(response.data.length == 0) {
                        console.log("getMyTrackMarkers");
                        return;
                    }

                    for(let e of response.data) {
                        console.log(e);
                        displayMyTrackMarker(e.latitude, e.longitude);

                    }

                });

            }

            function getTracingTrackMarkers() {

                removeTracingTrackAndInfoMarkers();

                const url = "./getTracingTrackMarkers?user_pk=" + myUserPk + "&trackMarkerDateValidity=" + trackMarkerDateValidity;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                        if(response.data.length == 0) {
                            console.log("getTracingTrackMarkers");
                            return;
                        }

                        for(let e of response.data) {
                            console.log(e);
                            displayTracingTrackAndInfoMarker(e);

                        }

                });

            }
            // qwer - 버튼과 연결
            function marking() {
                // poiu
                getMyLocation();
                isFirstTimeLeavingTrackMark();

            }

            function isFirstTimeLeavingTrackMark() {

                const url = "./isFirstTimeLeavingTrackMark?user_pk=" + myUserPk;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    if(response.data) {
                        console.log("isFirstTimeLeavingTrackMark : " + response.data);
                        // 처음 마커 남김
                        document.getElementById("alertContent").innerText = "처음 체취를 남기실 경우 추가 정보를 입력해주셔야 합니다";
                        showAndHideAlertModal();

                        setTimeout(() => {

                            showWriteMoreInfoModal();

                        }, alertTime);

                        return;
                    }

                    console.log("isFirstTimeLeavingTrackMark : " + response.data);

                    // 전에 남긴 적 있음
                    getCurrentMyTrackMarkerCount();

                });

            }
            // qwer
            function saveMoreInfo() {

                // 값 가져오기

                const url = "./insertMoreInfo?user_pk=" + myUserPk + "&height=" + height + "&weight=" + weight + "&blood_type=" + bloodType + "&mbti_type=" + mbtiType +
                    "&hobby=" + hobby + "&drinking=" + drinking + "&smoking=" + smoking + "&preference=" + preference;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    document.getElementById("alertContent").innerText = "추가정보 입력이 완료되었습니다";
                    showAndHideAlertModal();

                    setTimeout(() => {

                        // 전에 남긴 적 있음
                        hideWriteMoreInfoModal();
                        showWriteTrackMarkModal();

                    }, alertTime);

                });

            }

            function getCurrentMyTrackMarkerCount() {

                const url = "./getCurrentMyTrackMarkerCount?user_pk=" + myUserPk;

                fetch(url)
                .then(response => response.json())
                .then(response => {
                    console.log("getCurrentMyTrackMarkerCount : " + response.data);
                    if(response.data == trackMarkerUpTo) {

                        document.getElementById("alertContent").innerText = "횟수를 모두 사용하셨습니다";
                        showAndHideAlertModal();

                        return;

                    }

                    isEnoughDistanceFromMyTrackMarker();

                });

            }

            function isEnoughDistanceFromMyTrackMarker() {

                const url = "./isEnoughDistanceFromMyTrackMarker?user_pk=" + myUserPk + "&latitude=" + currentLat + "&longitude=" + currentLng +
                    "&trackMarkerEffectiveDistance=" + trackMarkerEffectiveDistance + "&trackMarkerDateValidity=" + trackMarkerDateValidity;

                fetch(url)
                .then(response => response.json())
                .then(response => {
                    console.log("isEnoughDistanceFromMyTrackMarker : " + response.data);
                    if(response.data) {

                        showWriteTrackMarkModal();

                        return;

                    }

                    document.getElementById("alertContent").innerText = "근처에 뿌린 체취가 있습니다";
                    showAndHideAlertModal();

                });

            }
            // qwer
            function saveWriteTrackMarkInfo() {

                // 값 가져오기

                const formData = new FormData();
                formData.append("user_pk", myUserPk);
                formData.append("imageFile", "asdf.png");
                formData.append("content", "content");
                formData.append("latitude", currentLat);
                formData.append("longitude", currentLng);

                const url = "./insertWriteTrackMarkInfo";
                const option = {
                    method: "post",
                    "Content-Type": "multipart/form-data",
                    body: formData
                };

                fetch(url, option)
                .then(response => {
                    console.log("saveWriteTrackMarkInfo");
                    hideWriteTrackMarkModal();
                    getMyTrackMarkers();

                });

            }

            function scanning() {
                // poiu
                getMyLocation();
                removeScanningTrackMarkers();
                getScanningTrackMarkers();
                
            }

            function getScanningTrackMarkers() {

                const url = "./getScanningTrackMarkers?user_pk=" + myUserPk + "&latitude=" + currentLat + "&longitude=" + currentLng +
                    "&trackMarkerDateValidity=" + trackMarkerDateValidity + "&scanMarkerEffectiveDistance=" + scanMarkerEffectiveDistance +
                    "&scanMarkerUpTo=" + scanMarkerUpTo;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    if(response.data.length == 0) {
                        console.log("getScanningTrackMarkers");
                        document.getElementById("alertContent").innerText = "근처에 뿌려진 체취가 없습니다";
                        showAndHideAlertModal();

                        return;

                    }

                    for(let e of response.data) {
                        console.log(e);
                        displayScanningTrackMarkers(e);

                    }

                });

            }

            function fillPreviewTrackMarkerModal(e) {

                resetPreviewTrackMarkerModal();

                // 값 채우기
                document.getElementById("collectTrackMarkerButton").onclick = () => {

                    getCurrentCollectTrackMarkerCount(e);

                };

                showPreviewTrackMarkerModal();
                
            }

            function getCurrentCollectTrackMarkerCount(e) {

                const url = "./getCurrentCollectTrackMarkerCount?user_pk=" + myUserPk;

                fetch(url)
                .then(response => response.json())
                .then(response => {
                    console.log("getCurrentCollectTrackMarkerCount : " + response.data);
                    if(response.data == collectMarkerUpTo) {

                        document.getElementById("alertContent").innerText = "횟수를 모두 사용하셨습니다";
                        showAndHideAlertModal();

                        return;

                    }

                    collectTrackMarkerInfo(e);

                });

            }

            // qwer
            function collectTrackMarkerInfo(e) {

                removeScanningTrackMarkers();
                fillTrackMarkerModal(e);
                saveCollectionInfo(e.log_pk);

            }

            function fillTrackMarkerModal(e) {

                resetTrackMarkerModal();

                // 값 채우기

                showTrackMarkerModal();

            }

            function saveCollectionInfo(logPk) {

                const url = "./insertCollectionInfo?user_pk=" + myUserPk + "&log_pk=" + logPk;

                fetch(url)
                .then(response => response.json())
                .then(response => {

                    hidePreviewTrackMarkerModal();

                });

            }

            function showAndHideAlertModal() {
                const modal = bootstrap.Modal.getOrCreateInstance("#alertModal");
                modal.show();

                setTimeout(() => {
                    modal.hide();
                }, alertTime);
            }

            function showWriteMoreInfoModal() {

                resetWriteMoreInfoModal();

                const modal = bootstrap.Modal.getOrCreateInstance("#writeMoreInfoModal");
                modal.show();

            }

            function hideWriteMoreInfoModal() {

                const modal = bootstrap.Modal.getOrCreateInstance("#writeMoreInfoModal");
                modal.hide();

            }
            
            function showWriteTrackMarkModal() {

                resetWriteTrackMarkModal();

                const modal = bootstrap.Modal.getOrCreateInstance("#writeTrackMarkModal");
                modal.show();

            }

            function hideWriteTrackMarkModal() {

                const modal = bootstrap.Modal.getOrCreateInstance("#writeTrackMarkModal");
                modal.hide();

            }
            
            function showPreviewTrackMarkerModal() {

                const modal = bootstrap.Modal.getOrCreateInstance("#previewTrackMarkerModal");
                modal.show();

            }

            function hidePreviewTrackMarkerModal() {

                const modal = bootstrap.Modal.getOrCreateInstance("#previewTrackMarkerModal");
                modal.hide();

            }

            function showTrackMarkerModal() {

                const modal = bootstrap.Modal.getOrCreateInstance("#trackMarkerModal");
                modal.show();

            }

            function resetWriteMoreInfoModal() {
                // modal 내용 초기화
            }

            function resetWriteTrackMarkModal() {
                // modal 내용 초기화
            }

            function resetPreviewTrackMarkerModal() {
                // modal 내용 초기화
            }

            function resetTrackMarkerModal() {
                // modal 내용 초기화
            }

            window.addEventListener("DOMContentLoaded", () => {

                getMyUserPk();
                createMap();
                getMyLocation();

            })

        </script>

    </head>

    <body>

        <!-- fetch(url)
                .then(response => response.json())
                .then(response => {

                    

        }); -->

        <button onclick="getMyLocation()">내 위치</button>
        <button onclick="marking()">체취</button>
        <button onclick="scanning()">시향</button>
        <button>추행</button>
        <button>내정보</button>
        <button>내 흔적</button>
        <button>내 가방</button>

        <div id="map" style="width: 50rem; height: 50rem;"></div>
        <div th:insert="~{/follow/asdf}"></div>

        <div id="alertModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content fw-bold text-white mx-auto" style="width: auto; font-size: 0.8rem; background: #D96161;">
                    <div id="alertContent" class="modal-body text-center">
                        
                    </div>
                </div>
            </div>
        </div>

        <div id="writeMoreInfoModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">
                        
                    </div>
                    <div class="modal-footer pb-2 border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary py-1" data-bs-dismiss="modal">닫기</button>
                        <button onclick="saveMoreInfo()" class="btn py-1 text-white" style="background: #D96161;">저장하기</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="writeTrackMarkModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-body">
                        
                    </div>
                    <div class="modal-footer pb-2 border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary py-1" data-bs-dismiss="modal">닫기</button>
                        <button onclick="saveWriteTrackMarkInfo()" class="btn py-1 text-white" style="background: #D96161;">체취등록</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="previewTrackMarkerModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer pb-2 border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary py-1" data-bs-dismiss="modal">닫기</button>
                        <button id="collectTrackMarkerButton" class="btn py-1 text-white" style="background: #D96161;">수집하기</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="trackMarkerModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer pb-2 border-0 justify-content-center">
                        <button type="button" class="btn btn-secondary py-1" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
       
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    </body>
    
</html>