<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>상품 리스트</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://kit.fontawesome.com/784384f602.js" crossorigin="anonymous"></script>
    <script src="/public/js/commons/naviBar.js"></script>
    <link rel="stylesheet" th:href="@{/public/css/commons/naviBar.css}"/>


    <script>

        function reloadCategory(){

            const url = "./getCategory";
            
            fetch(url)
            .then(response => response.json())
            .then(response => {
                const categoryListBox = document.getElementById("categoryListBox");
                categoryListBox.innerHTML = "";

                for(e of response.data){
                    const categoryText = document.querySelector("#template .category-text").cloneNode(true);
                    categoryText.innerText = e.name;
                    categoryText.setAttribute("data-value", e.pk);
                    
                    if (e === response.data[0]) {
                        categoryText.classList.add("selected");
                        reloadGoodsList(categoryText);
                    }else {
                        categoryText.classList.add("non-selected");
                    }


                    categoryListBox.appendChild(categoryText);
                }


            });

        }


        function reloadGoodsList(categoryText){

            const categoryListBox = document.getElementById("categoryListBox");

            categoryText.classList.add("selected");
            categoryText.classList.remove("non-selected");

            const otherTexts = categoryListBox.querySelectorAll(".category-text");
            otherTexts.forEach(text => {
                if (text !== categoryText) {
                    text.classList.remove("selected");
                    text.classList.add("non-selected");
                }
            });

            const categoryPk = categoryText.getAttribute("data-value");

            const url = "./getGoodsListByCategoryPk?categoryPk=" + categoryPk;
            


            fetch(url)
            .then(response => response.json())
            .then(response => {
                
                const goodsListBox = document.getElementById("goodsListBox");
                goodsListBox.innerHTML = "";

                for(e of response.data){
                    
                    const sessionUserPk = document.getElementById("sessionUserPk").value;

                    if(e.auctionGoodsDto.user_pk != sessionUserPk){
                        const goodsWrapper = document.querySelector("#template .goodsWrapper").cloneNode(true);

                        const goodsTitle = goodsWrapper.querySelector(".goods-title");
                        goodsTitle.innerText = e.auctionGoodsDto.title;

                        const goodsImage = goodsWrapper.querySelector(".goods-image");
                        goodsImage.setAttribute("src", "/uploadFiles/"+ e.auctionGoodsDto.image_link +"");

                        const time = goodsWrapper.querySelector(".time-text");
                        time.setAttribute("data-value", e.auctionGoodsDto.expiry_date);

                        const price = goodsWrapper.querySelector(".goods-price");
                        price.innerText = "KRW " + e.auctionGoodsDto.starting_price;

                        const name = goodsWrapper.querySelector(".name");
                        name.innerText = e.userDto.name;

                        const userId = goodsWrapper.querySelector(".user-id");
                        userId.innerText = e.userDto.userid

                        const goodsBox = goodsWrapper.querySelector(".goods-box");
                        goodsBox.setAttribute("data-value", e.auctionGoodsDto.pk);


                        goodsListBox.appendChild(goodsWrapper);
                    }

                }
                reloadRemainingTime();

            });
        }


        function navigateToGoodsDetailPage(goodsBox){
            const goodsPk = goodsBox.getAttribute("data-value");
            const goodsDetailtUrl = "./goodsDetailPage?goodsPk=" + goodsPk;
            window.location.href = goodsDetailtUrl;


        }


        function reloadRemainingTime() {
            // 모든 time-text 엘리먼트 선택
            const goodsListBox = document.getElementById("goodsListBox");
            const timeTexts = goodsListBox.querySelectorAll(".time-text");

            // 1초마다 실행되는 타이머 설정
            setInterval(() => {
                // 각 time-text 엘리먼트에 대해 처리
                timeTexts.forEach(timeText => {
                    // data-value에서 날짜 정보 가져오기
                    const expiryDateArray = timeText.getAttribute("data-value").split(',');
                    if(expiryDateArray){
                        const expiryYear = expiryDateArray[0];
                        const expiryMonth = expiryDateArray[1];
                        const expiryDays = expiryDateArray[2];
                        const expiryHour = expiryDateArray[3];
                        const expiryMinutes = expiryDateArray[4];
                        const expiry = expiryYear + '-' + expiryMonth + '-' + expiryDays + '- ' + expiryHour + ':' + expiryMinutes + ':00';

                        const expiryDate = new Date(expiry);
                        
                        const now = new Date();

                        const remainingTime = expiryDate - now;
                        if (remainingTime > 24 * 60 * 60 * 1000) {
                            // 24시간 이상 남은 경우
                            const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                            timeText.innerText = `${days}일 ${hours < 10 ? '0' : ''}${hours}:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        } else if (remainingTime > 60 * 60 * 1000) {
                            // 24시간 이하, 1시간 이상 남은 경우
                            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                            timeText.innerText = `${hours < 10 ? '0' : ''}${hours}:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        } else {
                            // 1시간 이하 남은 경우
                            const minutes = Math.floor(remainingTime / (1000 * 60));
                            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                            timeText.innerText = `00:${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        }
                    }


                });
            }, 1000); // 1초 간격으로 실행
        }



        function templete(){
		
            const url = "";
            
            fetch(url)
            .then(response => response.json())
            .then(response => {
                
            });
        }  


        window.addEventListener("DOMContentLoaded", () => {
            
            reloadCategory();
        });  

    </script>






    <style>
        body{
            background-color: #f5f5f5;
        }

        .container-fluid{
            background-color: #f5f5f5;
            padding-left: 1em;
            padding-right: 1em;
        }
        
        .searchbar-row{
            height: 5em;
            padding-top: 1em;
            padding-bottom: 1em;
        }

        .search-box{
            background-color: white;
            height: 3em;
            width: 90%;
            border-radius: 0.5em;
            border-width: 0;
            position: absolute;
            top: 50%;
            left: 1em;
            transform: translate(0, -50%);

        }

        .search-icon{
            font-size: 1.2em;
            position: absolute;
            top: 50%;
            left: 10%;
            transform: translate(0, -50%); 
        }

        .search-text{
            font-size: 0.8em;
            color: #777777;
            position: absolute;
            top: 50%;
            left: 22%;
            transform: translate(0, -50%);  
        }

        .more-icon-box{
            height: 3em;
            width: 3em;
            border-radius: 0.5em;
            background-color: white;
            position: absolute;
            top: 50%;
            right: 1em;
            transform: translate(0, -50%);
        }

        .more-icon{
            font-size: 1.2em;
            color: #777777;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);            
        }

        .category-text{
            color: #111111;
            font-size: 1.1em;
            margin-right: 2em;

        }

        .selected{
            border-bottom-style: solid; 
            border-bottom-width: 1; 
            border-bottom-color: #111111; 
            padding-bottom: 0.2em;
        }

        .non-selected{
            color: #777777;
        }

        .overflow-x-auto{
            overflow-x: auto;
            display: flex;
            padding-left: 1em;
        }

        .overflow-x-auto::-webkit-scrollbar{
            display: none;
        }

        .goods-box{
            position: relative;
            padding-left: 0;
            padding-right: 0;
            width: 100%;
            height: 23em;
        }

        .goods-image-cropping{
            border-radius: 1em;
            width: 100%;
            height: 23em;
            overflow: hidden;
            position: relative;
            border-style: solid;
            border-color: white;
            border-width: 0.5em;
        }

        .goods-image{
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .goods-image-opacity{
            background-color: rgba(68, 68, 68, 0.3);
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0%;
            z-index: 2;
        }

        .time-box{
            height: 1.6em;
            width: 7em;
            border-radius: 0.5em;
            position: absolute;
            top: 10%;
            left: 22%;
            transform: translate(0, -50%);
            z-index: 3;
        }

        .time-text{
            font-size: 0.8em;
            color: white;
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(0, -50%);
        }

        .wishlist-icon-box{
            height: 2.3em;
            width: 2.3em;
            border-radius: 100%;
            position: absolute;
            top: 10%;
            right: 6%;
            transform: translate(0, -50%);
            background-color: rgba(17, 17, 17, 0.5);
            z-index: 3;
        }

        .wishlist-icon{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1em;
        }

        .info-box{
            height: 5em;
            width: 88%;
            border-radius: 1em;
            position: absolute;
            bottom: 6%;
            left: 50%;
            transform: translate(-50%, 0);
            background-color: rgba(17, 17, 17, 0.5);
            z-index: 3;

        }

        .goods-title{
            color: #111111;
            font-size: 0.9em;
            font-weight: bold;
        }

        .user-id{
            position: absolute;
            top: 62%;
            left: 25%;
            transform: translate(0, -50%);
            color: #C0C0C0;
            font-size: 0.8em;
        }

        .goods-price{
            color: #111111;
            font-size: 0.9em;
            font-weight: bold;
        }

        .profile-image{
            width: 2.8em;
            height: 2.8em;
            border-radius: 100%;
            border-color: #444444;
            border-style: solid;
            border-width: 0.1em;
            position: absolute;
            top: 50%;
            left: 6%;
            transform: translate(0, -50%);
        }

        .name{
            font-size: 0.8em;
            color: #111111;
            position: absolute;
            top: 38%;
            left: 25%;
            transform: translate(0, -50%);
            color: white;
        }

        .goodsWrapper{
            padding-left: 1em; 
            padding-right: 1em; 
            padding-top: 1.5em;
        }

        .live-box{
            position: absolute;
            top: 10%;
            left: 6%;
            transform: translate(0, -50%);
            border-radius: 0.5em;
            width: 2.6em;
            height: 1.6em;
            z-index: 3;
            background-color: rgba(250, 7, 91, 0.8);
        }
        
        .live-text{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.8em;
        }

        .goods-info-box{
            background-color: white; 
            border-radius: 1em; 
            padding-bottom: 0.5em; 
            padding-top: 4em; 
            position: absolute; 
            top: -4em;
        }

    </style>

</head>





<body>

    <div class="container-fluid">
        <div th:insert="~{/commons/naviBar}"></div>
        <div class="row searchbar-row">
            <div class="col" style="position: relative;">
                <input class="search-box" type="text">
                <div class="search-icon"><i class="fa-solid fa-magnifying-glass" style="color: #777777;"></i></div>
                <div class="search-text fw-bold">검색어를 입력해 주세요.</div>
            </div>
            <div class="col-2" style="position: relative;">
                <div class="more-icon-box">
                    <div class="more-icon"><i class="bi bi-three-dots"></i></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col overflow-x-auto">
                <div class="row" style="display: flex;">
                    <div class="col overflow-x-auto">
                        <div id="categoryListBox" style="display: flex;">
                        
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div id="goodsListBox" class="col">



            </div>
        </div>
        <div class="row" style="height: 3em;"></div>
    </div>


    <!--템플릿-->
    <div id="template" class="d-none">

        <!--카테고리-->
        <div class="category-text fw-bold" onclick="reloadGoodsList(this)"></div>

        <!--상품 리스트-->
        <div class="row goodsWrapper" style="padding-bottom: 6em;">
            <div class="col">
                <div class="row">
                    <div class="col goods-box" onclick="navigateToGoodsDetailPage(this)">
                        <div class="goods-image-cropping">
                            <img class="goods-image img-fluid">   
                            <div class="goods-image-opacity"></div> 
                        </div>
                        <div class="live-box">
                            <div class="live-text">Live</div>
                        </div>  
                        <div class="time-box text-center">
                            <div class="time-text"></div>
                        </div>
                        <div class="wishlist-icon-box">
                            <div class="wishlist-icon"><i class="fa-solid fa-heart" style="color: #ffffff;"></i></div>
                        </div>
                        <div class="info-box">
                            <img class="profile-image" th:src="@{/public/image/trade/puppy1.jpg}">
                            <div class="name"></div>
                            <div class="user-id">hello3054</div>                            
                        </div>
                    </div>
                </div>
                <div class="row" style="position: relative;">
                    <div class="col goods-info-box">
                        <div class="row" style="padding-top: 0.5em;">
                            <div class="col">
                                <div class="goods-title"></div>
                            </div>
                        </div>
                        <div class="row" style="padding-top: 0.2em;">
                            <div class="col">
                                <div class="goods-price"></div>
                            </div>
                        </div>
                        <div class="row" style="padding-top: 0.5em; padding-bottom: 0.2em;">
                            <div class="col" style="display: flex; align-items: center; justify-content: end;">
                                <div style="color: #444444; font-size: 0.9em;"><i class="fa-solid fa-heart"></i></div>
                                <div class="fw-bold" style="padding-left: 0.5em; color: #444444; font-size: 0.9em;">13</div>
                                <div style="padding-left: 2em; display: flex; align-items: center; font-size: 0.9em;"><img style="width: 1em; height: 1em;" th:src = "@{/public/image/trade/dogpawblack.png}"></div>
                                <div class="fw-bold" style="padding-left: 0.5em; color: #444444; font-size: 0.9em;">15</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input id="sessionUserPk" type="hidden" th:value="${session.sessionUser.user_pk}">

     <script src="/public/js/commons/lockLikeMobile.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>

</html>