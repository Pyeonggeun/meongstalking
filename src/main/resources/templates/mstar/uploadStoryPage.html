<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <script src="https://kit.fontawesome.com/fdd6196f61.js" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

        <script th:inline="javascript">
            let user_pk = null;
            function getUrlKey() {
                const urlParams = new URLSearchParams(location.search);
                const key = urlParams.get("user_pk");
                user_pk = key;
            }

            let profile_info_Dto = null;
            
            function loadMyProfileInfo(){
                const url = "./loadMyProfileInfo";

                fetch(url, {
                     method: "post",
                     headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                     body: "user_pk="+user_pk
            	})
                .then(response => response.json())
                .then((response) =>{

                    profile_info_Dto = response.data.profileInfoDto;

                    const profilePhoto = document.querySelector("#profilePhoto");
                    profilePhoto.setAttribute("src", response.data.profileInfoDto.profile_photo);

                    storyPhotoUpload();
                })
            }
            function showFileUploadModal(){
                const fileUploadModal = bootstrap.Modal.getOrCreateInstance("#fileUploadModal");
                fileUploadModal.show();
            }
            function hideFileUploadModal(){
                const fileUploadModal = bootstrap.Modal.getOrCreateInstance("#fileUploadModal");
                fileUploadModal.hide();
            }

            // 파일 업로드 감지 이베트
            function storyPhotoUpload(){
                const fileUpload = document.querySelector("#fileUpload");
                fileUpload.click();
                const story_img = document.getElementById("story_img");
            
                const handleFiles = (e) => {
                    hideFileUploadModal();
                    const selectedFile = [...fileUpload.files];
                    const fileReader = new FileReader();
                        if (e.target.files.length === 0) {  
                            return   
                        }else{
                            fileReader.readAsDataURL(selectedFile[0]);
                        
                            
                            fileReader.onload = function () {
                                story_img.style.backgroundImage = "url("+fileReader.result+")";
                            }  
                        }; 
                    };
                fileUpload.addEventListener("change", handleFiles);
            }
            function insertStory(){
                const story_img = document.querySelector("#story_img");
                
                const storyTextBox = document.querySelector("#storyTextBox");
                const X = parseInt(storyTextBox.style.left);
                const Y = parseInt(storyTextBox.style.top);
                const {width: story_imgWidth, height: story_imgHeight} = story_img.getBoundingClientRect();
                
                const x_coordinates = X/story_imgWidth*100;
                const y_coordinates = Y/story_imgHeight*100;

                const fileUpload = document.querySelector("#fileUpload");
                const imageFiles = fileUpload.files[0];
                const formData = new FormData();
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', './insertStory', true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        console.log(xhr.responseText);
                    }
                };
                const profile_info_pk = profile_info_Dto.profile_info_pk;
                const story_text = document.querySelector("#story_textAndColor").innerText;
                const text_color = document.querySelector("#story_textAndColor").style.color;
                console.log(text_color);
                console.log(imageFiles);
                console.log(story_text);
                console.log(x_coordinates);
                console.log(y_coordinates);
                console.log(profile_info_pk);

                formData.append("imageFiles", imageFiles);
                formData.append("story_text", story_text);
                formData.append("x_coordinates", x_coordinates);
                formData.append("y_coordinates", y_coordinates);
                formData.append("profile_info_pk", profile_info_pk);
                formData.append("text_color", text_color);
                

                xhr.send(formData);

               //location.href='./profilePage?user_pk='+user_pk;
            }
          

            function showTextBox() {
                const textButton = bootstrap.Modal.getOrCreateInstance("#textButton");
                textButton.show();
                const story_text = document.querySelector("#story_text");
                story_text.focus();
                const storyControllBar = document.querySelector("#storyControllBar");
                storyControllBar.classList.add("d-none");

                const colorPicker = document.querySelector("#colorPicker");
                const color = colorPicker.value;
                story_text.style.color = color;

                const storyTextBox = document.querySelector("#storyTextBox");
                storyTextBox.classList.add("d-none")

     	    }
            function colorPickerChange(){
                const colorPicker = document.querySelector("#colorPicker");
                const color = colorPicker.value;

                const story_text = document.querySelector("#story_text");
                story_text.style.color= color;
            
            }

            function makeTextBox(){
                
                
                const colorPicker = document.querySelector("#colorPicker");
                const color = colorPicker.value;
                

                const storyControllBar = document.querySelector("#storyControllBar");
                storyControllBar.classList.remove("d-none");

                const textButton = bootstrap.Modal.getOrCreateInstance("#textButton");
                textButton.hide();

                const story_text = document.querySelector("#story_text");
                const storyTextBox = document.querySelector("#storyTextBox");

                const story_textAndColor = document.querySelector("#story_textAndColor");
                story_textAndColor.setAttribute("style", "color:"+color+";");
                story_textAndColor.innerText = "";
                story_textAndColor.innerText = story_text.value;

                storyTextBox.classList.remove("d-none");

            }
            function moveTextBox(){
                const story_img = document.querySelector("#story_img");
                
                const storyTextBox = document.querySelector("#storyTextBox");
                
                const {width: story_imgWidth, height: story_imgHeight} = story_img.getBoundingClientRect();
                const {width: storyTextBoxWidth, height: storyTextBoxHeight} = storyTextBox.getBoundingClientRect();
                
                let isDragging = null;
                let originLeft = null;
                let originTop = null;
                let originX = null;
                let originY = null;

                storyTextBox.addEventListener("touchstart" , (e)=>{
                    console.log("실행")
                    isDragging = true;
                    var startId = e.targetTouches[0].target.id;
                    
                

                    var startX = e.changedTouches[0].clientX;
                    var startY = e.changedTouches[0].clientY;
                
                    
                    originX = startX;
                    originY = startY;
                    originLeft = storyTextBox.offsetLeft;
                    originTop = storyTextBox.offsetTop;
                });

                document.addEventListener("touchend",(e)=>{
                    console.log("마우스 업")
                    storyTextBox.classList.remove("top-50","start-50", "translate-middle");
                    isDragging = false;
                });

                document.addEventListener("touchmove", (e)=>{
                    if(isDragging){
                        
                        
                        var moveId = e.targetTouches[0].target.id;

                        var moveX = e.changedTouches[0].clientX;
                        var moveY = e.changedTouches[0].clientY;
                        

                        const diffX = moveX - originX;
                        const diffY = moveY - originY;
                        const endOfXPoint = story_imgWidth - storyTextBoxWidth;
                        const endOfYPoint = story_imgHeight - storyTextBoxHeight;
                       
                       

                        storyTextBox.setAttribute("style", "left:"+Math.min(Math.max(0, originLeft+diffX), endOfXPoint)+"px;top:"+Math.min(Math.max(0, originTop+diffY), endOfYPoint)+"px;");

                        // const diffX = e.clientX - originX;
                        // const diffY = e.clientY - originY;
                        // const endOfXPoint = story_imgWidth - storyTextBoxWidth;
                        // const endOfYPoint = story_imgHeight - storyTextBoxHeight;
                        
                        // storyTextBox.setAttribute("style", "left:"+Math.min(Math.max(0, originLeft+diffX), endOfXPoint)+"px;top:"+Math.min(Math.max(0, originTop+diffY), endOfYPoint)+"px;");  
                    }
                });

            }

          

            function showColorPicker(){
                const colorPicker = document.querySelector("#colorPicker");
                colorPicker.click();
            }
            window.addEventListener("DOMContentLoaded", () =>{
                getUrlKey();
                loadMyProfileInfo();
                showFileUploadModal();
            });

        </script>
        <style>

            @font-face {
                font-family: 'omyu_pretty';
                src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2304-01@1.0/omyu_pretty.woff2') format('woff2');
                font-weight: normal;
                font-style: normal;
            }

            body {
                font-family: 'omyu_pretty';
                overflow: hidden;
            }
            #d-none-scroll::-webkit-scrollbar {
                display: none;
            }
            .spotLight{
                filter: brightness(90%);
           }
            
        </style>
        
    </head>

    <body>
        <div class="container-fluid bg-white" style="width: 100%;">
            <input id="fileUpload" name="imageFiles" class="d-none" type="file" accept="image/*">
            <div id="story_img" class="row upload-img position-relative" style=" height: 160vw; background-size: 100%; background-repeat: no-repeat; background-position: center;">
                <div id="storyControllBar" class="col px-0"> 
                    <div class="row mt-2" style="width: 100%;">
                        <div onclick=window.history.back(); class="col-auto ms-3 rounded-circle text-white" style="background-color: rgb(55, 54, 54); opacity: 0.7; aspect-ratio: 1/1; height: 10vw;">
                            <i class="fa-solid fa-xmark pt-2 fs-4"></i>
                        </div>
                        <div class="col-5"></div>
                        <div onclick=window.history.back(); class="col-auto ms-2 rounded-circle text-white text-end" style="background-color: rgb(55, 54, 54); opacity: 0.7; aspect-ratio: 1/1; height: 10vw;">
                            <i class="fa-solid fa-tag fs-4 pt-2"></i>
                        </div>
                        <div onclick=showTextBox(); class="col-auto ms-2 rounded-circle text-white text-end" style="background-color: rgb(55, 54, 54); opacity: 0.7; aspect-ratio: 1/1; height: 10vw;">
                            <i class="fa-sharp fa-solid fa-a pt-2"></i>
                        </div>
                        <div onclick=window.history.back(); class="col-auto ms-2 rounded-circle text-white text-end" style="background-color: rgb(55, 54, 54); opacity: 0.7; aspect-ratio: 1/1; height: 10vw;">
                            <i class="fa-solid fa-camera-rotate pt-2"></i>
                        </div>
                    </div>   
                </div>
                <div id="storyTextBox" onmousedown="moveTextBox()" class="col-auto position-absolute" style="cursor: pointer; top: 50%; left: 50%;">
                    <div id="story_textAndColor">
                        
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col px-3">
                    <div class="row rounded-pill" style="background-color: rgb(231, 225, 225);">
                        <div class="col-auto">
                            <img id="profilePhoto" class="rounded-circle img-fluid border border-2 border-white"  alt="" style="aspect-ratio: 1/1; height: 8vw;">
                        </div>
                        <div class="col align-self-center">
                            내 스토리
                        </div>
                    </div>
                </div>
                <div class="col pe-3">
                    <div class="row  rounded-pill" style="background-color: rgb(231, 225, 225);">
                        <div class="col-auto">
                            <img class="rounded-circle img-fluid border border-2 border-white" src="../../3img/miu.jpeg" alt="" style="aspect-ratio: 1/1; height: 8vw;">
                        </div>
                        <div class="col align-self-center">
                            공개범위
                        </div>
                    </div>
                </div>
                <div class="col-auto me-3">
                    <div class="row rounded-circle" style="background-color: rgb(231, 225, 225); height: 8vw; aspect-ratio: 1/1;">
                        <div onclick="insertStory()" class="col">
                            <i class="fa-sharp fa-solid fa-arrow-right pt-1 "></i>
                        </div>
                    </div>
                </div>
            </div>    
        </div>
        <div id="textButton" class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background-color: transparent; border: transparent;">
                    <div id="textControllBar" class="row fs-4">
                        <div class="col-5"></div>
                        <div class="col-auto text-white text-center">
                            <i class="fa-sharp fa-solid fa-bars" style="padding-top: 1.5vw;"></i>
                        </div>
                        <div class="col-auto text-center">
                            <input id="colorPicker" onchange="colorPickerChange()" type="color" class="form-control form-control-color d-none" value="#fafafa">
                            <img onclick="showColorPicker()" class="img-fluid rounded-circle border border-white border-2" src="../../3img/colorpicker.png" alt="" height="" style="height: 6.5vw;">
                        </div>
                        <div onclick="makeTextBox()" class="col text-white text-end">
                            완료
                        </div>
                    </div>
                  <div class="modal-body" style="top: 30vw;">
                    <div  id="textColor" class="col">
                        <input id="story_text" class="form-control" type="text" style="border: transparent; background-color: transparent; height: 50vw;">
                    </div>
                  </div>
              </div>
            </div>
        </div>
        <div id="fileUploadModal" class="modal" tabindex="-1" style="top: 7em;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header py-2">  
                      
                    </div>
                    <div class="modal-body py-0">
                      스토리 등록을 위해서는 이미지를 등록해 주셔야합니다.
                    </div>
                    <div class="modal-footer py-1">
                      <button onclick="window.history.back()" type="button" class="btn btn-secondary py-0">돌아가기</button>
                      <button onclick="storyPhotoUpload()" type="button" class="btn btn-primary py-0">파일 찾기</button>
                    </div>
                  </div>
            </div>
        </div>

       

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>

</html>